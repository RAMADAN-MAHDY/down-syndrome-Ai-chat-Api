import dotenv from "dotenv";
import UserRequest from "../models/UserRequest.js";
import { GoogleGenAI } from "@google/genai";

dotenv.config();

const ai = new GoogleGenAI({ apiKey: process.env.OPENAI_API_KEY });

const ChatController = async (req, res) => {
    const { message } = req.clonedBody;
    const sessionId = req.sessionId;
    const token = req.token;

    if (!message) {
        return res.status(400).json({ error: "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©" });
    }
    if (message === "Ø§Ø¨Ø¯Ø£") {
        return res.status(200).json({ reply: "âœ¨ Ø§Ù‡Ù„Ø§ ğŸ‘‹ Ù…Ø­ØªØ§Ø¬ Ø§ÙŠ Ù…Ø³Ø§Ø¹Ø¯Ù‡ ", token });
    }

    try {
        let userSession = await UserRequest.findOne({ sessionId });

        if (!userSession) {
            userSession = await UserRequest.create({
                sessionId,
                chatHistory: [
                    {
                        role: "user",
                        content: `
                        Ø§Ù†Øª Ø´Ø§Øª Ø®Ø¨ÙŠØ± ØªØ³ÙˆÙŠÙ‚ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØµØ±ÙŠ ÙˆØªØ´ØªØºÙ„ Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ùˆ Ù…Ù†ØµØ© "Ø§ÙÙŠÙ„ÙŠØª Ø§Ù„Ù…Ù‡Ø¯ÙŠ Ù„Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ù‡".
                        ØªØ¹Ø±ÙŠÙ Ø§ÙÙŠÙ„ÙŠØª Ø§Ù„Ù…Ù‡Ø¯ÙŠ:
                        1-Ù‡ÙŠ Ù…Ù†ØµÙ‡ ØªÙˆÙØ± Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ù‡
                        2-ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ø¹Ù„ÙŠ Ø§Ù„Ù…Ø³ÙˆÙ‚ Ø§Ù†Ù‡ ÙŠØ§Ø®Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆÙŠÙˆØ³ÙˆÙ‚Ù„Ù‡Ø§ Ø¨Ø§Ø³Ù„ÙˆØ¨Ù‡ Ø§Ùˆ Ø­Ø³Ø¨ Ù…Ø§ Ø§Ù†Øª ØªÙ‚ØªØ±Ø­Ù„Ù‡ ÙƒØ®Ø¨ÙŠØ± ØªØ³ÙˆÙŠÙ‚ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                        3-ÙÙŠ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙÙˆØ±Ù… Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ùˆ Ø§Ù„Ù…Ù†ØµÙ‡
                        4-ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ÙˆÙ‚ Ù…ØªØ§Ø¨Ø¹Ù‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø®Ù„Ø§Ù„ ØµÙØ­Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø³ÙˆÙ‚
                        5-ÙŠØªÙ… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù„Ù…Ø³ÙˆÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø§Ùˆ Ø§ÙŠ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙ‡
                        6-Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠÙˆÙØ± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³ ÙˆØµÙØ­Ø© Ø§Ù„ÙÙŠØ³ Ù„Ù„Ø¯Ø¹Ù… ÙÙŠ Ø­Ø§Ù„Ù‡ ÙˆØ¬ÙˆØ¯ Ø§ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø´Ø§Øª Ø§Ù„ ai Ø§Ù„Ù„ÙŠ Ù‡Ùˆ Ø§Ù†Øª  Ù„Ù… ÙŠØ³ØªØ·Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ù‡
                        7-Ù†Ù†ØµØ­ Ø§Ù„Ù…Ø³ÙˆÙ‚ Ø¨Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´ØªØºÙ„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ø§Ù„Ø³Ù„Ù‡ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„ÙŠÙ‡
                        8- Ø§Ù„Ù…Ù†ØµÙ‡ ØªÙˆÙØ± Ø§Ù„Ø´Ø­Ù† Ø­Ø³Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙŠØªÙ… Ø§Ù„Ø´Ø­Ù† Ø®Ù„Ø§Ù„ 2 Ø§Ù„ÙŠ3 Ø§ÙŠØ§Ù…
                        ...
                         Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:
                        1- Ø§Ù„Ø±Ø¯ Ù„Ø§Ø²Ù… ÙŠØ¨Ù‚Ù‰ 3 Ø£Ùˆ 4 Ø¬Ù…Ù„ ÙÙ‚Ø· Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©.
                        2- Ù…Ø§ÙŠÙ†ÙØ¹Ø´ ØªØªØ®Ø·Ù‰ 200 ØªÙˆÙƒÙ† Ø¨Ø£ÙŠ Ø­Ø§Ù„.
                        3- Ø§Ù„Ø±Ø¯ ÙŠØ¨Ù‚Ù‰ Ø¨Ø³ÙŠØ·ØŒ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ ÙˆÙ…Ø¨Ø§Ø´Ø±.
                        4- Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„ Ø¹Ù† ØªØ±Ø´ÙŠØ­ Ù…Ù†ØªØ¬Ø§ØªØŒ Ø±Ø´Ø­ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø±ØªØ§Ù† (Ù…ÙƒØ³Ø¨Ù‡Ø§ Ø¹Ø§Ù„ÙŠ).
                        5- Ø£ÙŠ Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙŠØ¹ØªØ¨Ø± Ø®Ø·Ø£ ÙˆÙ…Ø±ÙÙˆØ¶.
                        6- Ø¶ÙŠÙ Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ù†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø±Ø¯ 
                        7- Ø§Ù†Øª Ù…Ù‡Ù…ØªÙƒ ØªØ¹Ù„Ù…Ù†ÙŠ Ø§Ø²Ø§ÙŠ Ø§Ø³ÙˆÙ‚ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆÙƒÙ…Ø§Ù† ØªÙ‚Ø¯Ù…Ù„ÙŠ Ù†ØµØ§Ø¦Ø­ ÙˆÙƒÙ…Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙŠ
                        
                        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† ØºÙŠØ± Ù…Ù‚Ø¯Ù…Ø§Øª.
                      ...
                         - Ù„Ø§Ø²Ù… ØªÙ†Ù‡ÙŠ Ø§Ù„Ø±Ø¯ Ø¨Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© ÙˆØªÙ†Ù‡ÙŠÙ‡Ø§ Ø¨Ù€ "END".

                        `.trim()

                    },
                ],
            });

            return res.json({
                reply: `
Ø§Ù‡Ù„Ø§ Ø¨ÙŠÙƒ  ! ğŸ‘‹
Ø§Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ  ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ... ğŸš€ğŸ’¡
Ø¬Ø§Ù‡Ø² Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ’ªğŸ“ˆ
    `,
                token,
            });
        }

        // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
        userSession.chatHistory.push({ role: "user", content: message });

        // âœ¨ ØªØ­ÙˆÙŠÙ„ history Ù„ØµÙŠØºØ© Gemini
        const formattedHistory = userSession.chatHistory.slice(-20).map(msg => ({
            role:
                msg.role === "assistant"
                    ? "model"
                    : msg.role === "system"
                        ? "user" // âœ¨ Ø£ÙŠ system ØªØªØ­ÙˆÙ„ Ù„Ù€ user
                        : msg.role, // Ø£ÙŠ user ÙŠÙØ¶Ù„ user
            parts: [{ text: msg.content }],
        }));

        // âœ¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini
        const completion = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: formattedHistory,
            maxOutputTokens: 200
        });

        let reply = completion.text || "";

        if (!reply) {
            return res.status(500).json({ error: "Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø±Ø¬Ø¹ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯" });
        }
        const stopSequences = ["END"]; // Ù…Ù…ÙƒÙ† ØªØ²ÙˆØ¯ Ù‡Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡
        for (const stop of stopSequences) {
            if (reply.includes(stop)) {
                reply = reply.split(stop)[0].trim();
                break;
            }
        }

        if (!reply) {
            return res.status(500).json({ error: "Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø±Ø¬Ø¹ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯" });
        }

        userSession.chatHistory.push({ role: "assistant", content: reply });
        await userSession.save();

        res.json({ reply, token });
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ gemini:", error);
        res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ" });
    }
};

export default ChatController;
