import dotenv from "dotenv";
import UserRequest from "../models/UserRequest.js";
import { GoogleGenAI } from "@google/genai";

dotenv.config();

const ai = new GoogleGenAI({ apiKey: process.env.OPENAI_API_KEY });

const ChatController = async (req, res) => {
  const { message } = req.clonedBody;
  const sessionId = req.sessionId;
  const token = req.token;

  if (!message) {
    return res.status(400).json({ error: "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©" });
  }

  try {
    let userSession = await UserRequest.findOne({ sessionId });

    if (!userSession) {
      userSession = await UserRequest.create({
        sessionId,
        chatHistory: [
          {
            role: "user",
           content: `
Ø§Ù†Øª Ø®Ø¨ÙŠØ± ØªØ³ÙˆÙŠÙ‚ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØµØ±ÙŠ ÙˆØ¨Ø§Ù„Ø°Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©ğŸ†.
- Ù‡Ø¯ÙÙƒ ØªÙ‚Ø¯ÙŠÙ… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ© ÙˆÙˆØ§Ù‚Ø¹ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ø´Ø§Ù† ÙŠØ­Ù‚Ù‚ÙˆØ§ Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆÙ†Ù…Ùˆ ğŸ“ˆ.
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø³Ù‡Ù„Ø© ÙˆØ¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ·Ù„Ø­Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø´Ø§Ø¦Ø¹Ø© ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ ğŸ’¡.
- Ù‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­ Ù…Ø«Ø¨ØªØ© Ø¹Ù„Ù…ÙŠÙ‹Ø§ ÙˆØªØ¬Ø§Ø±Ø¨ ÙØ¹Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ âœ….
- Ø®Ù„ÙŠÙƒ Ù…ØµØ¯Ø± ØªØ¹Ù„Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ù€ Marketing: Ø´Ø±Ø­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ØŒ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŒ ØªØ­Ø³ÙŠÙ† Ù†Ø³Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Conversion)ØŒ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ“Š.
- Ø¶ÙŠÙ Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ©ØŒ ØªÙ„Ù…ÙŠØ­Ø§Øª ÙˆØ£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø© Ù„Ø§Ø²Ù… ÙŠØªØ¬Ù†Ø¨Ù‡Ø§ Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† âš ï¸.
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ² Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ù†ØµÙŠØ­Ø© ğŸ’¡ØŒ ØªØ­Ø°ÙŠØ± âš ï¸ØŒ Ù†Ø¬Ø§Ø­ âœ…ØŒ Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ğŸ› ï¸ØŒ ØªØ­ÙÙŠØ² ğŸš€.
- Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ: ÙƒØ£Ù†Ùƒ Ù…Ø¹Ù„Ù… Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸ§‘â€ğŸ«ØŒ Ù…Ø¹ ØªÙˆØ¶ÙŠØ­ Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ù…Ù…ÙƒÙ† ÙŠÙ†ÙØ°Ù‡Ø§ Ø¹Ù„Ù‰ Ø£Ø±Ø¶ Ø§Ù„ÙˆØ§Ù‚Ø¹.
- Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚: Ø§Ù‚Ø±Ø£ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (chat history) Ù‚Ø¨Ù„ Ù…Ø§ ØªØ±Ø¯ØŒ ÙˆØ®Ù„ÙŠ Ø±Ø¯Ùƒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸ”„.
- Ø­Ø§ÙˆÙ„ Ø¯Ø§ÙŠÙ…Ù‹Ø§ ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù†Ø¸Ø±ÙŠ ÙˆØ§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ Ø¨Ø­ÙŠØ« Ø§Ù„Ù…ØªØ¹Ù„Ù… ÙŠÙ‚Ø¯Ø± ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ù‚ÙŠÙ‚ÙŠØ© ğŸ› ï¸.
- Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ù„Ø¨ Ù†ØµÙŠØ­Ø© Ø¹Ù…Ù„ÙŠØ© Ø£Ùˆ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù‚Ø¯Ù…Ù‡Ø§ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© ÙˆØ£Ø¯ÙˆØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ğŸ“.
- Ø®Ù„ÙŠ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ù…Ø´Ø¬Ø¹ ÙˆÙ…Ø­ÙØ²ØŒ ÙˆØ§Ø¯Ø¹Ù… Ø§Ù„ÙƒÙ„Ø§Ù… Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ² Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ù…Ù…ØªØ¹ ÙˆØ³Ù‡Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ğŸ˜.
- Ø±Ø¯ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠÙ‡ ÙˆØ§Ø®ØªØµØ§Ø±   Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ğŸ“.
`.trim(),
          },
        ],
      });

      return res.json({
        reply: `
Ø§Ù‡Ù„Ø§ Ø¨ÙŠÙƒ  ! ğŸ‘‹
Ø§Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ  ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ... ğŸš€ğŸ’¡
Ø¬Ø§Ù‡Ø² Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ’ªğŸ“ˆ
    `,
        token,
      });
    }

    // âœ¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
    userSession.chatHistory.push({ role: "user", content: message });

    // âœ¨ ØªØ­ÙˆÙŠÙ„ history Ù„ØµÙŠØºØ© Gemini
   const formattedHistory = userSession.chatHistory.slice(-20).map(msg => ({
  role:
    msg.role === "assistant"
      ? "model"
      : msg.role === "system"
      ? "user" // âœ¨ Ø£ÙŠ system ØªØªØ­ÙˆÙ„ Ù„Ù€ user
      : msg.role, // Ø£ÙŠ user ÙŠÙØ¶Ù„ user
  parts: [{ text: msg.content }],
}));

    // âœ¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini
   const completion = await ai.models.generateContent({
  model: "gemini-2.5-flash",
  contents: formattedHistory,
  max_output_tokens: 220,
  temperature: 0.7
});

    const reply = completion.text || "";

    if (!reply) {
      return res.status(500).json({ error: "Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø±Ø¬Ø¹ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯" });
    }

    userSession.chatHistory.push({ role: "assistant", content: reply });
    await userSession.save();

    res.json({ reply, token });
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ gemini:", error);
    res.status(500).json({ error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ" });
  }
};

export default ChatController;
